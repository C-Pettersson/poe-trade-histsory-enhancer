#!/bin/sh
set -eu

msg_file="${1:-}"
if [ -z "$msg_file" ] || [ ! -f "$msg_file" ]; then
  echo "commit-msg hook: missing commit message file argument" >&2
  exit 1
fi

first_line="$(head -n 1 "$msg_file" | tr -d '\r')"

# Allow merge commits and auto-generated reverts without enforcing the format.
case "$first_line" in
  "Merge "* | "Revert "*) exit 0 ;;
esac

# Allow fixup/squash commits (but still validate the underlying message if present).
line="$(printf '%s' "$first_line" | sed -E 's/^(fixup! |squash! )//')"

pattern='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([[:alnum:]_.-]+\))?(!)?: .+'
if ! printf '%s' "$line" | grep -Eq "$pattern"; then
  cat >&2 <<'EOF'
ERROR: Commit message must follow Conventional Commits.

Format:
  type(scope)!: description

Examples:
  feat: add income stats
  fix(parser): handle missing item
  chore: remove auto-refresh
EOF
  echo "" >&2
  echo "Got:" >&2
  echo "  $first_line" >&2
  exit 1
fi

